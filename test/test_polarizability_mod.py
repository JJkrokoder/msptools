import numpy as np
import msptools as mspt

def test_Clausius_Mossotti():
    radius = 0.08  # um
    medium_permittivity = 1
    系1 = -2.5676
    系2 = 3.6391
    particle_permittivity = 系1 + 系2 * 1j  # e.g., gold at 500 nm

    alpha = mspt.polarizability_mod.Clausius_Mossotti(radius, medium_permittivity, particle_permittivity)
    expected_alpha = 4 * np.pi * radius**3 * (particle_permittivity - medium_permittivity) / (particle_permittivity + 2 * medium_permittivity)
    
    assert np.isclose(alpha, expected_alpha), f"Expected {expected_alpha}, got {alpha}"


def test_negative_real_polarizability_at_532nm_Au():
    radius = 60  # um
    medium_permittivity = 1.33**2
    wavelength_nm = 532  # nm
    frequency_eV = mspt.nm_to_eV(wavelength_nm)
    particle_permittivity = mspt.permittivity.permittivity_ridx(frequency_eV, 'Au')

    alpha = mspt.polarizability_mod.Mie_size_dipole_approximation(radius, medium_permittivity, particle_permittivity, mspt.frequency_to_wavenumber_nm(frequency_eV))
    
    assert alpha.real < 0, f"Expected negative real part of polarizability for Au, got {alpha.real}"

def test_Zhou_data_with_Mie_dipole_approximation():
    radius = 80  # nm
    medium_permittivity = 1.33**2
    wavelengths_nm = np.array([400.9234828496042, 412.0052770448549, 422.16358839050133, 431.39841688654354, 439.70976253298153, 448.94459102902374, 457.2559366754617, 465.5672823218997, 472.9551451187335, 479.41952506596306, 486.8073878627968, 494.19525065963063, 503.43007915567284, 509.8944591029024, 515.4353562005277, 521.8997361477573, 529.2875989445911, 536.6754617414248, 544.0633245382586, 551.4511873350923, 558.8390501319261, 566.2269129287599, 573.6147757255936, 579.155672823219, 584.6965699208444, 589.3139841688654, 593.9313984168865, 597.6253298153034, 601.3192612137203, 605.0131926121372, 608.7071240105541, 611.4775725593668, 615.1715039577837, 617.9419525065963, 620.7124010554089, 623.4828496042217, 625.3298153034301, 628.1002638522427, 631.7941952506596, 634.5646437994723, 637.335092348285, 640.1055408970976, 642.8759894459104, 645.646437994723, 648.4168865435356, 651.1873350923483, 653.957783641161, 657.6517150395778, 661.3456464379947, 664.1160949868074, 667.8100263852243, 670.5804749340369, 673.3509234828496, 676.1213720316623, 679.8153034300792, 682.5857519788918, 686.2796833773087, 689.9736147757255, 694.5910290237467, 698.2849604221635, 702.9023746701847, 708.4432717678101, 713.9841688654353, 720.448548812665, 727.8364116094987, 736.1477572559368, 744.4591029023748, 751.8469656992085, 761.0817941952507, 770.3166226912929, 780.4749340369393, 790.6332453825858, 799.8680738786279, 808.1794195250659, 817.4142480211083, 828.4960422163588, 838.6543535620053, 848.8126649076517, 858.9709762532982, 870.9762532981531, 882.0580474934037, 894.0633245382586, 905.1451187335092, 915.3034300791556, 927.3087071240105, 941.1609498680739, 953.1662269129288, 966.0949868073878, 979.023746701847, 993.7994722955145, 1007.6517150395779, 1021.5039577836412, 1039.9736147757258, 1055.6728232189973, 1072.2955145118735, 1086.1477572559365, 1100.9234828496042])  # nm
    frequency_eV = mspt.nm_to_eV(wavelengths_nm)
    particle_permittivity = mspt.permittivity.permittivity_ridx(frequency_eV, 'Au')

    alpha_nm = mspt.polarizability_mod.Mie_size_dipole_approximation(radius, medium_permittivity, particle_permittivity, mspt.frequency_to_wavenumber_nm(frequency_eV))
    alpha_real_zhou = (1e-23)*np.array([61.97183098591546, 59.15492957746477, 53.521126760563334, 50.704225352112644, 47.887323943661954, 42.25352112676052, 36.61971830985914, 28.169014084507012, 14.084507042253506, -2.8169014084507467, -25.35211267605638, -47.88732394366201, -76.05633802816902, -101.4084507042254, -123.94366197183103, -143.66197183098592, -160.56338028169017, -174.64788732394368, -185.9154929577465, -188.73239436619718, -191.5492957746479, -185.9154929577465, -174.64788732394368, -160.56338028169017, -140.84507042253523, -121.12676056338029, -98.59154929577466, -78.87323943661977, -53.52112676056339, -28.16901408450707, 0, 28.169014084507012, 59.15492957746477, 87.32394366197178, 112.67605633802816, 140.84507042253517, 169.01408450704218, 197.1830985915492, 228.169014084507, 261.9718309859154, 295.7746478873239, 332.394366197183, 369.0140845070422, 400, 433.8028169014084, 467.6056338028168, 501.4084507042253, 538.0281690140845, 571.8309859154929, 611.2676056338028, 647.8873239436618, 676.056338028169, 704.2253521126759, 729.5774647887324, 757.7464788732393, 783.0985915492956, 811.2676056338028, 839.4366197183099, 864.7887323943662, 887.3239436619717, 912.676056338028, 935.2112676056338, 954.9295774647887, 974.6478873239435, 994.3661971830984, 1008.450704225352, 1016.9014084507041, 1019.7183098591549, 1022.5352112676055, 1022.5352112676055, 1019.7183098591549, 1014.0845070422533, 1011.2676056338028, 1002.8169014084506, 997.1830985915492, 988.732394366197, 980.2816901408451, 969.0140845070421, 960.5633802816901, 949.2957746478871, 940.8450704225352, 929.5774647887324, 921.1267605633802, 912.676056338028, 904.2253521126759, 895.7746478873239, 887.3239436619717, 878.8732394366195, 870.4225352112676, 861.9718309859154, 853.5211267605632, 845.0704225352113, 836.6197183098591, 828.1690140845069, 822.5352112676055, 816.9014084507041, 811.2676056338028])
    
    assert np.allclose(alpha_nm.real*(1e-9)**3, alpha_real_zhou, atol=1e-5), "Mie dipole approximation does not match Zhou data within tolerance."

